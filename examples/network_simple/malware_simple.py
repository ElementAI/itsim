from greensim import advance, local
from greensim.random import expo, distribution

from itsim.network import Internet
from itsim.it_objects.decorators import malware
from itsim.it_objects.endpoint import Endpoint
from itsim.it_objects.location import Location
from itsim.it_objects.payload import Payload
from itsim.types import as_address

import network_simple

BAD_NEWS_BEAR_ADDR = "1.2.3.4"
BAD_NEWS_BEAR_PORT = 666
LOCAL_ROUTER_PORT = 777
LOCAL_ROUTER_ADDR = "4.3.2.1"


@malware
def no_good(ws: Endpoint) -> None:
    global BAD_NEWS_BEAR_PORT, BAD_NEWS_BEAR_ADDR

    logger = network_simple.get_logger()
    local.name = f"Calling the Mothership / {ws.name}"

    with ws.open_socket(BAD_NEWS_BEAR_PORT) as socket:
        while True:
            advance(next(expo(100)))
            logger.info("Exfiltrating something valuable")
            socket.send(Location(router_inet_addr, LOCAL_ROUTER_PORT),
                        100,
                        Payload({"SIN": "514-416-604",
                                 "dest_addr": Location(BAD_NEWS_BEAR_ADDR, BAD_NEWS_BEAR_PORT)}))


@malware
def command_and_control(ws: Endpoint) -> None:
    global BAD_NEWS_BEAR_PORT

    logger = network_simple.get_logger()
    local.name = f"Receiving Data / {ws.name}"
    with ws.open_socket(BAD_NEWS_BEAR_PORT) as socket:
        while True:
            packet = socket.recv()
            logger.info("Got a nastygram: %s" % packet)


# Define a one-way router for simplicity. I'm not sure about the best way to define one in our current framework
def route(ws: Endpoint) -> None:
    global LOCAL_ROUTER_PORT, LOCAL_ROUTER_ADDR
    logger = network_simple.get_logger()
    local.name = f"Conducting Traffic / {ws.name}"

    with ws.open_socket(Location(router_inet_addr, LOCAL_ROUTER_PORT)) as i_socket:
        with ws.open_socket(Location(LOCAL_ROUTER_ADDR, LOCAL_ROUTER_PORT)) as world_socket:
            while True:
                msg = i_socket.recv()
                logger.info("Routing packet from %s to %s" % (msg.source, msg.payload.entries["dest_addr"]))
                world_socket.send(msg.payload.entries["dest_addr"], msg.byte_size, msg.payload)


sim, time, workstations = network_simple.init()

www = Internet(sim)

virus = network_simple.Workstation("Hungry Cub", network_simple.net_local)
virus.install(network_simple.workstation_blinking)
virus.install(network_simple.client_activity, distribution(workstations))
virus.install(network_simple.mdns_daemon)
virus.install(no_good)

router = Endpoint("Router", www, LOCAL_ROUTER_ADDR)
router_inet_addr = as_address(router.link_to(network_simple.net_local)._address)
router.install(route)

bad_news_bear = Endpoint("Mama Bear", www, BAD_NEWS_BEAR_ADDR)
bad_news_bear.install(command_and_control)

sim.run(time)
