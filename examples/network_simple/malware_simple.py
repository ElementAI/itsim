from greensim import add, advance, local, Process, tagged
from greensim.random import expo, distribution

from itsim.network import Internet
from itsim.it_objects import ITTag
from itsim.it_objects.decorators import malware
from itsim.it_objects.endpoint import Endpoint
from itsim.it_objects.location import Location
from itsim.it_objects.payload import Payload
from itsim.types import as_address

import network_simple

BAD_NEWS_BEAR_ADDR = "1.2.3.4"
BAD_NEWS_BEAR_PORT = 666
LOCAL_ROUTER_PORT = 777


def log(ws: Endpoint, action: str, msg: str) -> None:
    tags = "<%s>" % ", ".join([str(t) for t in Process.current().iter_tags()])
    local.name = f"{ws.name} / {action} / {tags}"
    network_simple.get_logger().info(msg)


@malware
def no_good(ws: Endpoint) -> None:
    while True:
        advance(next(expo(100)))
        add(sudo_transmit, ws, "my_sin")


@tagged(ITTag.VULNERABLE)
def sudo_transmit(ws: Endpoint, filename: str) -> None:
    log(ws, "Priveleged Access", f"Reading {filename}")
    add(exfiltrate, ws, "514-416-604")


def exfiltrate(ws: Endpoint, sin: str) -> None:
    global BAD_NEWS_BEAR_PORT, BAD_NEWS_BEAR_ADDR, LOCAL_ROUTER_PORT, router_local_addr

    log(ws, "Calling the Mothership", "Exfiltrating something valuable")
    with ws.open_socket(BAD_NEWS_BEAR_PORT) as socket:
        socket.send(Location(router_local_addr, LOCAL_ROUTER_PORT),
                    100,
                    Payload({"SIN": sin,
                             "dest_addr": Location(BAD_NEWS_BEAR_ADDR, BAD_NEWS_BEAR_PORT)}))


@malware
def command_and_control(ws: Endpoint) -> None:
    global BAD_NEWS_BEAR_PORT

    with ws.open_socket(BAD_NEWS_BEAR_PORT) as socket:
        while True:
            packet = socket.recv()
            log(ws, "Receiving Data", "Got a nastygram: %s" % packet)


# Define a one-way router for simplicity. I'm not sure about the best way to define one in our current framework
def route(ws: Endpoint) -> None:
    global LOCAL_ROUTER_PORT, router_local_addr

    with ws.open_socket(Location(router_local_addr, LOCAL_ROUTER_PORT)) as i_socket:
        with ws.open_socket(Location(router_inet_addr, LOCAL_ROUTER_PORT)) as world_socket:
            while True:
                msg = i_socket.recv()
                log(ws,
                    "Conducting Traffic",
                    "Routing packet from %s to %s" % (msg.source, msg.payload.entries["dest_addr"]))
                world_socket.send(msg.payload.entries["dest_addr"], msg.byte_size, msg.payload)


sim, time, workstation_list, router = network_simple.init()

www = Internet(sim)

infected = next(distribution(workstation_list))
infected.install(no_good)

router_local_addr = router.address_default
router_inet_addr = as_address(router.link_to(www)._address)
router.install(route)

bad_news_bear = Endpoint("Mama Bear", www, BAD_NEWS_BEAR_ADDR)
bad_news_bear.install(command_and_control)

sim.run(time)
